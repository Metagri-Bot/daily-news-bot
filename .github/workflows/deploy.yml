name: Deploy Daily News Bot

on:
  push:
    branches: [ "main" ] # mainブランチにプッシュされたときに実行
  workflow_dispatch: # 手動でも実行できるようにする

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. リポジトリのコードをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. SSH接続をセットアップ
      - name: Setup SSH
        uses: MrSquaare/ssh-setup-action@v2.0.1
        with:
          host: ${{ secrets.SSH_HOST }}
          private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 3. サーバーで使う .env ファイルをSecretsから生成
      - name: Write .env file
        run: |
          echo "DISCORD_BOT_TOKEN=${{ secrets.DISCORD_BOT_TOKEN }}" >> .env
          echo "NEWS_CHANNEL_ID=${{ secrets.NEWS_CHANNEL_ID }}" >> .env
          echo "GOOGLE_APPS_SCRIPT_URL=${{ secrets.GOOGLE_APPS_SCRIPT_URL }}" >> .env
          echo "BIGNER_ROLE_ID=${{ secrets.BIGNER_ROLE_ID }}" >> .env
          echo "METAGRI_ROLE_ID=${{ secrets.METAGRI_ROLE_ID }}" >> .env
          echo "NEWS_RSS_FEEDS_AGRICULTURE=${{ secrets.NEWS_RSS_FEEDS_AGRICULTURE }}" >> .env
          echo "NEWS_RSS_FEEDS_WEB3=${{ secrets.NEWS_RSS_FEEDS_WEB3 }}" >> .env
           # ▼▼▼ この行を追加 ▼▼▼
          echo "INFO_GATHERING_CHANNEL_ID=${{ secrets.INFO_GATHERING_CHANNEL_ID }}" >> .env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env          
      # 4. SSH経由でサーバーにDocker Composeコマンドを送信してデプロイ
      - name: Deploy with Docker Compose
        run: docker compose up --build -d
        env:
          DOCKER_HOST: 'ssh://${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}'
